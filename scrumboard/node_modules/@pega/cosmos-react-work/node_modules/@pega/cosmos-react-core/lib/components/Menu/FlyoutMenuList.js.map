{"version":3,"file":"FlyoutMenuList.js","sourceRoot":"","sources":["../../../src/components/Menu/FlyoutMenuList.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  forwardRef,\n  FunctionComponent,\n  MutableRefObject,\n  PropsWithoutRef,\n  useContext,\n  useEffect,\n  useRef,\n  useState,\n  useMemo,\n  useCallback,\n  useLayoutEffect\n} from 'react';\n\nimport { ForwardProps } from '../../types';\nimport { useAfterInitialEffect, useConsolidatedRef, useItemIntersection } from '../../hooks';\nimport Progress from '../Progress';\nimport EmptyState from '../EmptyState';\nimport Popover from '../Popover';\n\nimport { MenuListProps, ParentMenuItemProps } from './Menu.types';\nimport MenuContext from './Menu.context';\nimport MenuItem from './MenuItem';\nimport { StyledLoadingItem, StyledMenuList, StyledFlyoutMenuListContainer } from './Menu.styles';\nimport { resizeRootEl } from './NavItemsList';\nimport helpers from './helpers';\nimport MenuGroup from './MenuGroup';\n\nconst FlyoutMenuList: FunctionComponent<MenuListProps & ForwardProps> = forwardRef(\n  ({ items, parent, menuRole }: PropsWithoutRef<MenuListProps>, ref: MenuListProps['ref']) => {\n    const selfRef = useConsolidatedRef(ref);\n    const ulRef = useRef<HTMLUListElement>(null);\n    const menuListWrapperRef: MutableRefObject<HTMLElement | null> = useRef(null);\n    const returnFocusRef: MutableRefObject<HTMLButtonElement | null> = useRef(null);\n    const [expandedItem, setExpandedItem] = useState<ParentMenuItemProps>();\n    const {\n      componentId,\n      loadMore,\n      loading,\n      scrollAt,\n      emptyText,\n      onItemExpand,\n      pushFlyoutId,\n      flyOutActiveIdStack,\n      updateActiveDescendants,\n      updateParentDescendantStack\n    } = useContext(MenuContext);\n\n    useItemIntersection(\n      ulRef,\n      items.length - 1,\n      () => {\n        loadMore?.(parent?.item?.id);\n      },\n      ':scope > li'\n    );\n\n    useAfterInitialEffect(() => {\n      if (expandedItem) {\n        setExpandedItem(items.find(item => item.id === expandedItem.id) as ParentMenuItemProps); // FIXME\n      }\n    }, [expandedItem, items]);\n\n    useEffect(() => {\n      const hasExpanded = items.some(item => {\n        return flyOutActiveIdStack.includes(item.id);\n      });\n\n      if (!hasExpanded) {\n        returnFocusRef.current = null;\n        setExpandedItem(undefined);\n      }\n    }, [flyOutActiveIdStack]);\n\n    const listContent = useMemo(() => {\n      if (items.length) {\n        return items.map(item => {\n          return helpers.isItem(item) ? (\n            <MenuItem\n              {...item}\n              key={item.id}\n              aria-haspopup={!!item.items}\n              aria-expanded={item.id === expandedItem?.id}\n              role={menuRole === 'listbox' ? 'option' : 'menuitem'}\n              onExpand={(id, e) => {\n                if (item.items) {\n                  returnFocusRef.current = e.currentTarget as HTMLButtonElement;\n                  setExpandedItem(item as ParentMenuItemProps); // FIXME\n                  item?.onExpand?.(id, e);\n                  onItemExpand?.(id, e);\n                  pushFlyoutId(item.id || componentId);\n                  updateActiveDescendants();\n                  if (updateParentDescendantStack) {\n                    updateParentDescendantStack(returnFocusRef.current.closest('li'));\n                  }\n                } else {\n                  returnFocusRef.current = null;\n                  setExpandedItem(undefined);\n                }\n              }}\n            />\n          ) : (\n            <MenuGroup\n              {...item}\n              key={item.id}\n              itemRole={menuRole === 'listbox' ? 'option' : 'menuitem'}\n            />\n          );\n        });\n      }\n\n      if (!loading) {\n        return <EmptyState message={emptyText} forwardedAs='li' />;\n      }\n\n      return null;\n    }, [items, loading, emptyText, expandedItem, flyOutActiveIdStack]);\n\n    const list = (\n      <StyledMenuList ref={ulRef} role={menuRole}>\n        {listContent}\n        {loading && !expandedItem && (\n          <StyledLoadingItem>\n            <Progress placement='local' />\n          </StyledLoadingItem>\n        )}\n      </StyledMenuList>\n    );\n\n    useLayoutEffect(() => {\n      setExpandedItem(undefined);\n      if (selfRef.current) {\n        menuListWrapperRef.current = selfRef.current.parentElement;\n        resizeRootEl(selfRef.current, selfRef.current, items.length, scrollAt);\n      }\n    }, [items]);\n\n    const handleMenuListScroll = useCallback(() => {\n      if (expandedItem) {\n        setExpandedItem(undefined);\n      }\n    }, [expandedItem]);\n\n    return (\n      <>\n        <StyledFlyoutMenuListContainer\n          ref={selfRef}\n          onScroll={handleMenuListScroll}\n          data-flyout-menu-parent-id={componentId}\n          data-flyout-menu-id={parent?.item.id || componentId}\n        >\n          {list}\n        </StyledFlyoutMenuListContainer>\n\n        {expandedItem && selfRef.current && (\n          <Popover target={returnFocusRef.current} show strategy='fixed' placement='right-start'>\n            <FlyoutMenuList\n              items={expandedItem.items}\n              parent={{\n                el: selfRef.current,\n                item: expandedItem,\n                siblingItems: items,\n                setExpandedItem,\n                returnFocusRef\n              }}\n              menuRole={menuRole}\n            />\n          </Popover>\n        )}\n      </>\n    );\n  }\n);\n\nexport default FlyoutMenuList;\n"]}