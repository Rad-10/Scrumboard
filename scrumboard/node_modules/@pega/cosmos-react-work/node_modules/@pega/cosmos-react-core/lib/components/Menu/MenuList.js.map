{"version":3,"file":"MenuList.js","sourceRoot":"","sources":["../../../src/components/Menu/MenuList.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  forwardRef,\n  FunctionComponent,\n  MutableRefObject,\n  PropsWithoutRef,\n  useContext,\n  useEffect,\n  useLayoutEffect,\n  useRef,\n  useState,\n  useMemo,\n  Fragment,\n  useCallback,\n  MouseEvent\n} from 'react';\n\nimport { ForwardProps } from '../../types';\nimport Drawer from '../Drawer';\nimport {\n  useAfterInitialEffect,\n  useConsolidatedRef,\n  useItemIntersection,\n  useDirection\n} from '../../hooks';\nimport Progress from '../Progress';\nimport EmptyState from '../EmptyState';\n\nimport type {\n  AcceptedMouseEventElement,\n  MenuListProps,\n  ParentMenuItemProps,\n  MenuItemProps\n} from './Menu.types';\nimport MenuContext from './Menu.context';\nimport MenuListHeader from './MenuListHeader';\nimport MenuItem from './MenuItem';\nimport helpers from './helpers';\nimport {\n  StyledLoadingItem,\n  StyledMenuList,\n  StyledMenuListContainer,\n  StyledSeparator\n} from './Menu.styles';\nimport { resizeRootEl } from './NavItemsList';\nimport MenuGroup from './MenuGroup';\n\nconst setParentDisabled = (fieldset: HTMLFieldSetElement, bool: boolean) => {\n  fieldset.disabled = bool;\n  const legendButton = fieldset.querySelector<HTMLButtonElement>('legend button');\n  if (legendButton) {\n    legendButton.disabled = bool;\n  }\n};\n\nconst countVisibleItems = (menuItems: MenuListProps['items']): number => {\n  return menuItems.reduce<number>((acc, item) => {\n    const isFlatGroup = !helpers.isItem(item);\n    if (isFlatGroup && item.items) {\n      return acc + item.items.length + 1;\n    }\n\n    return acc + 1;\n  }, 0);\n};\n\nconst MenuList: FunctionComponent<MenuListProps & ForwardProps> = forwardRef(\n  (\n    { items, parent, id, menuRole, ...restProps }: PropsWithoutRef<MenuListProps>,\n    ref: MenuListProps['ref']\n  ) => {\n    const menuListWrapperRef: MutableRefObject<HTMLElement | null> = useRef(null);\n    const selfRef = useConsolidatedRef(ref);\n    const ulRef = useRef<HTMLUListElement>(null);\n    const returnFocusRef: MutableRefObject<HTMLButtonElement | null> = useRef(null);\n    const [open, setOpen] = useState(!parent);\n    const [expandedItem, setExpandedItem] = useState<ParentMenuItemProps>();\n    const {\n      scrollAt,\n      loadMore,\n      loading,\n      emptyText,\n      currentItemId,\n      onItemExpand,\n      focusControl,\n      updateActiveDescendants,\n      setFocusReturnEl,\n      onItemCollapse\n    } = useContext(MenuContext);\n    const { end } = useDirection();\n\n    useItemIntersection(\n      ulRef,\n      items.length - 1,\n      () => {\n        if (!loading) loadMore?.(parent?.item?.id);\n      },\n      ':scope > li'\n    );\n\n    useLayoutEffect(() => {\n      if (!selfRef.current || expandedItem) return;\n      menuListWrapperRef.current = selfRef.current.parentElement;\n      resizeRootEl(\n        selfRef.current,\n        menuListWrapperRef.current as HTMLElement,\n        countVisibleItems(items),\n        scrollAt\n      );\n    });\n\n    useEffect(() => {\n      if (parent) setOpen(true);\n    }, []);\n\n    useAfterInitialEffect(() => {\n      if (expandedItem) {\n        setExpandedItem(items.find(item => item.id === expandedItem.id) as ParentMenuItemProps); // FIXME\n      }\n    }, [expandedItem, items]);\n\n    useAfterInitialEffect(() => {\n      if (currentItemId) {\n        // if there is ancestor item of the controlled item, set it to expanded.\n        const ancestor = items.find(\n          item => item.items?.length && helpers.getItem(item.items, currentItemId) !== undefined\n        );\n\n        if (ancestor) {\n          setExpandedItem(ancestor as ParentMenuItemProps);\n          updateActiveDescendants({ preventScroll: true });\n        }\n      }\n    }, [currentItemId, items, parent]);\n\n    const onExpandCallback = useCallback(\n      (itemId: MenuItemProps['id'], e: MouseEvent<AcceptedMouseEventElement>) => {\n        const item = helpers.getItem(items, itemId);\n        returnFocusRef.current = e.currentTarget as HTMLButtonElement;\n        setExpandedItem(item as ParentMenuItemProps); // FIXME\n        item?.onExpand?.(itemId, e);\n        onItemExpand?.(itemId, e);\n        updateActiveDescendants({ preventScroll: true });\n      },\n      [items]\n    );\n\n    const listContent = useMemo(() => {\n      if (items.length) {\n        return items.map((item, index) => {\n          return helpers.isItem(item) ? (\n            <MenuItem\n              {...item}\n              key={item.id}\n              role={menuRole === 'listbox' ? 'option' : 'menuitem'}\n              onExpand={item.items ? onExpandCallback : undefined}\n            />\n          ) : (\n            <Fragment key={item.id}>\n              <MenuGroup {...item} itemRole={menuRole === 'listbox' ? 'option' : 'menuitem'} />\n              {items[index + 1] && helpers.isItem(items[index + 1]) && (\n                <StyledSeparator role='separator' />\n              )}\n            </Fragment>\n          );\n        });\n      }\n\n      if (!loading) {\n        return <EmptyState message={emptyText} forwardedAs='li' />;\n      }\n\n      return null;\n    }, [items, loading, emptyText]);\n\n    const list = (\n      <StyledMenuList id={expandedItem ? undefined : id} ref={ulRef} role={menuRole} {...restProps}>\n        {parent && (\n          <li role='presentation'>\n            <MenuListHeader\n              text={parent.item.primary}\n              onClick={() => {\n                setOpen(false);\n              }}\n            />\n          </li>\n        )}\n        {listContent}\n        {loading && !expandedItem && (\n          <StyledLoadingItem>\n            <Progress placement='local' />\n          </StyledLoadingItem>\n        )}\n      </StyledMenuList>\n    );\n\n    return (\n      <>\n        <Drawer\n          aria-hidden={!!expandedItem}\n          as={StyledMenuListContainer}\n          ref={selfRef}\n          open={open}\n          style={{ opacity: expandedItem ? 0 : 1 }}\n          disabled={!!expandedItem}\n          placement={end}\n          onBeforeOpen={() => {\n            if (parent) {\n              parent.el.style.opacity = '0';\n            }\n\n            if (selfRef.current) {\n              selfRef.current.style.opacity = '1';\n            }\n          }}\n          onAfterOpen={() => {\n            if (parent) {\n              setParentDisabled(parent.el, true);\n            }\n          }}\n          onBeforeClose={() => {\n            if (parent && menuListWrapperRef.current) {\n              setParentDisabled(parent.el, false);\n              parent.el.style.opacity = '1';\n              resizeRootEl(\n                parent.el,\n                menuListWrapperRef.current,\n                countVisibleItems(parent.siblingItems),\n                scrollAt\n              );\n            }\n\n            if (selfRef.current) {\n              selfRef.current.style.opacity = '0';\n            }\n          }}\n          onAfterClose={() => {\n            if (parent) {\n              focusControl?.focus();\n\n              const expandBtn = parent.returnFocusRef.current;\n              parent.setExpandedItem(undefined);\n\n              if (expandBtn) {\n                setFocusReturnEl(expandBtn?.closest('li'));\n              }\n\n              onItemCollapse?.(parent.item.id);\n              updateActiveDescendants();\n            }\n          }}\n        >\n          {list}\n        </Drawer>\n\n        {expandedItem && selfRef.current && (\n          <MenuList\n            id={id}\n            items={expandedItem.items}\n            parent={{\n              el: selfRef.current,\n              item: expandedItem,\n              siblingItems: items,\n              setExpandedItem,\n              returnFocusRef\n            }}\n            menuRole={menuRole}\n          />\n        )}\n      </>\n    );\n  }\n);\n\nexport default MenuList;\n"]}